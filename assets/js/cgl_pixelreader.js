(()=>{"use strict";CGL.PixelReader=class{constructor(){this.pixelData=null,this._finishedFence=!0,this._size=0,this._pbo=null}_fence(e){const t=e.gl;return this._finishedFence=!1,new Promise((function(i,n){if(e.aborted)return;let r=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);r&&(t.flush(),function s(){if(e.aborted)return;const l=t.clientWaitSync(r,0,0);if(l==t.WAIT_FAILED)console.error("fence wait failed"),n&&n();else{if(l==t.TIMEOUT_EXPIRED)return setTimeout(s,0);l==t.CONDITION_SATISFIED||l==t.ALREADY_SIGNALED?(i(),t.deleteSync(r)):console.log("unknown fence status",l)}}())}))}read(e,t,i,n,r,s,l,a){if(CABLES.UI&&(!CABLES.UI.loaded||performance.now()-CABLES.UI.loadedTime<1e3))return;if(!this._finishedFence)return;const _=e.gl;let f=1;if(e.aborted)return;if(!t)return;i===CGL.Texture.TYPE_FLOAT&&(i=CGL.Texture.PFORMATSTR_RGBA32F);let h=CGL.Texture.isPixelFormatFloat(i);h&&(f=4);const o=CGL.Texture.setUpGlPixelFormat(e,i),u=o.numColorChannels*s*l;if(0==s||0==l||0==u)return;this._pixelData&&this._size==u*f||(this._pixelData=h?new Float32Array(u*f):new Uint8Array(u),this._size=u*f);let F=_.UNSIGNED_BYTE;if(h&&(F=_.FLOAT),0==this._size||!this._pixelData)return void console.error("readpixel size 0",this._size,s,l);this._finishedFence&&(this._pbo=_.createBuffer(),_.bindBuffer(_.PIXEL_PACK_BUFFER,this._pbo),_.bufferData(_.PIXEL_PACK_BUFFER,this._pixelData.byteLength,_.DYNAMIC_READ),_.bindFramebuffer(_.FRAMEBUFFER,t),_.bindBuffer(_.PIXEL_PACK_BUFFER,this._pbo),e.profileData.profileFencedPixelRead++,_.readPixels(n,r,s,l,_.RGBA,o.glDataType,0),_.bindBuffer(_.PIXEL_PACK_BUFFER,null),_.bindFramebuffer(_.FRAMEBUFFER,null));let E=this._pixelData.byteLength;return this._finishedFence&&this._pbo&&this._fence(e).then((e=>{this._wasTriggered=!1,this._finishedFence=!0,!e&&this._pixelData&&this._pixelData.byteLength==E&&(_.bindBuffer(_.PIXEL_PACK_BUFFER,this._pbo),_.getBufferSubData(_.PIXEL_PACK_BUFFER,0,this._pixelData),_.bindBuffer(_.PIXEL_PACK_BUFFER,null),a&&a(this._pixelData)),_.deleteBuffer(this._pbo),this._pbo=null})),!0}},((this.CGL=this.CGL||{}).COREMODULES=this.CGL.COREMODULES||{}).Pixelreader={}.Pixelreader})();